<!-- CAJA 3.html -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Caja 3 - Registro de Tickets</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #e9f0f7;
      margin: 0;
      padding: 1.5rem 1rem;
      color: #2c3e50;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h2 {
      font-weight: 700;
      color: #2ecc71;
      margin-bottom: 1rem;
      letter-spacing: 1.2px;
    }
    label {
      font-weight: 600;
      margin-bottom: 0.4rem;
      display: block;
      font-size: 1rem;
      color: #34495e;
    }
    input[type="text"] {
      width: 100%;
      max-width: 320px;
      padding: 0.5rem 0.75rem;
      border: 2px solid #bdc3c7;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s ease;
      margin-bottom: 1.2rem;
    }
    select {
      width: 100%;
      max-width: 320px;
      padding: 0.5rem 0.75rem;
      border: 2px solid #bdc3c7;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s ease;
      margin-bottom: 1.2rem;
      background: white;
      color: #2c3e50;
    }
    input[type="text"]:focus {
      border-color: #2ecc71;
      outline: none;
      box-shadow: 0 0 6px #2ecc71aa;
    }
    #productos {
      width: 100%;
      max-width: 480px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 6px 15px rgb(0 0 0 / 0.1);
      padding: 1rem 1.2rem;
      margin-bottom: 1.5rem;
    }
    .producto {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.6rem 0;
      border-bottom: 1px solid #ecf0f1;
      font-size: 1.05rem;
    }
    .producto:last-child {
      border-bottom: none;
    }
    .separador {
      font-weight: 700;
      color: #1c5a8a;
      padding: 0.5rem 0;
      margin: 0.4rem 0;
      border-bottom: 1px dashed #ecf0f1;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      font-size: 0.95rem;
      user-select: none;
    }
    .producto label {
      flex-grow: 1;
      cursor: pointer;
      user-select: none;
      display: flex;
      align-items: center;
      gap: 0.8rem;
      color: #34495e;
    }
    .producto input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: #2ecc71;
      border-radius: 4px;
    }
    .cantidad-controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      min-width: 110px;
      justify-content: flex-end;
    }
    .cantidad-controls button {
      background: #2ecc71;
      color: white;
      border: none;
      border-radius: 6px;
      width: 32px;
      height: 32px;
      font-weight: 700;
      font-size: 1.2rem;
      line-height: 1;
      cursor: pointer;
      transition: background-color 0.3s ease;
      user-select: none;
    }
    .cantidad-controls button:hover {
      background: #27ae60;
    }
    .cantidad-controls span {
      min-width: 24px;
      text-align: center;
      font-weight: 600;
      font-size: 1.1rem;
      color: #2c3e50;
      user-select: none;
    }
    .cursos-container {
      display: flex;
      gap: 1.5rem;
      max-width: 680px;
      margin-bottom: 1.2rem;
      flex-wrap: wrap;
      justify-content: center;
    }
    .curso-column {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      flex: 1;
      min-width: 200px;
    }
    .curso-column label {
      margin-bottom: 0.4rem;
    }
    .curso-column select {
      max-width: 100%;
    }
    .calculadora-cambio {
      width: 100%;
      max-width: 480px;
      background: linear-gradient(135deg, #e8f8f0 0%, #b3e8d5 100%);
      border-radius: 12px;
      box-shadow: 0 6px 15px rgb(0 0 0 / 0.15);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      border: 2px solid #2ecc71;
    }
    .calculadora-cambio h3 {
      margin-top: 0;
      font-weight: 700;
      font-size: 1.3rem;
      color: #2c3e50;
      margin-bottom: 1rem;
      text-align: center;
    }
    .calculadora-cambio label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: #2c3e50;
    }
    .calculadora-cambio input[type="number"] {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #2ecc71;
      border-radius: 8px;
      font-size: 1rem;
      margin-bottom: 1.2rem;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
      font-weight: 600;
    }
    .calculadora-cambio input[type="number"]:focus {
      border-color: #27ae60;
      outline: none;
      box-shadow: 0 0 8px #2ecc71aa;
    }
    .resultado-cambio {
      background: white;
      border-radius: 8px;
      padding: 1rem;
      border: 1px solid #ecf0f1;
    }
    .cambio-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.8rem 0;
      border-bottom: 1px solid #ecf0f1;
      color: #34495e;
      font-weight: 600;
    }
    .cambio-item:last-child {
      border-bottom: none;
    }
    .cambio-item.cambio-total {
      background: #ecf0f1;
      padding: 0.8rem;
      border-radius: 6px;
      margin-top: 0.5rem;
      border: none;
    }
    .cambio-valor {
      font-weight: 700;
      font-size: 1.1rem;
      color: #2ecc71;
    }
    .cambio-valor-total {
      font-size: 1.4rem;
      color: #27ae60;
    }
    .total {
      font-weight: 700;
      font-size: 1.5rem;
      color: #2ecc71;
      margin-bottom: 1.2rem;
      text-align: center;
      user-select: none;
    }
    .confirmar {
      background-color: #27ae60;
      color: white;
      border: none;
      border-radius: 10px;
      padding: 0.75rem 2rem;
      font-size: 1.15rem;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 6px 12px rgb(39 174 96 / 0.5);
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
      user-select: none;
      display: block;
      margin: 0 auto 1rem auto;
      max-width: 200px;
      width: 100%;
    }
    .confirmar:hover {
      background-color: #1e8746;
      box-shadow: 0 8px 18px rgb(30 135 70 / 0.7);
    }
    .resumen, .historial {
      width: 100%;
      max-width: 480px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 6px 15px rgb(0 0 0 / 0.1);
      padding: 1.2rem 1.5rem;
      font-family: monospace;
      color: #34495e;
      overflow-x: auto;
      white-space: pre-wrap;
      word-break: break-word;
      margin-bottom: 1.5rem;
      user-select: text;
    }
    .resumen h3, .historial h3 {
      margin-top: 0;
      font-weight: 700;
      font-size: 1.3rem;
      color: #2c3e50;
      margin-bottom: 0.8rem;
    }
    @media (max-width: 520px) {
      #productos, .resumen, .historial, .calculadora-cambio {
        max-width: 100%;
        padding: 1rem;
      }
      input[type="text"] {
        max-width: 100%;
      }
      .cursos-container {
        flex-direction: column;
        gap: 1rem;
      }
      .curso-column {
        min-width: 100%;
      }
    }
  </style>
</head>
<body>
  <h2>üìç Caja 3 (3er piso)</h2>
  <label for="nombreEstudiante">Nombre del estudiante:</label>
  <input type="text" id="nombreEstudiante" placeholder="Nombre del estudiante" />

  <div class="cursos-container">
    <div class="curso-column">
      <label for="cursoEspanol">Curso (Espa√±ol):</label>
      <select id="cursoEspanol" aria-label="Curso en espa√±ol">
        <option value="">Selecciona</option>
        <optgroup label="Nivel Inicial">
          <option value="Prekinder">Prekinder</option>
          <option value="Kinder">Kinder</option>
          <option value="Pre-Primario">Pre-Primario</option>
        </optgroup>
        <optgroup label="Primaria">
          <option value="1ero de primaria">1ero de primaria</option>
          <option value="2do de primaria">2do de primaria</option>
          <option value="3ro de primaria">3ro de primaria</option>
          <option value="4to de primaria">4to de primaria</option>
          <option value="5to de primaria">5to de primaria</option>
          <option value="6to de primaria">6to de primaria</option>
        </optgroup>
        <optgroup label="Secundaria">
          <option value="1ero de secundaria">1ero de secundaria</option>
          <option value="2do de secundaria">2do de secundaria</option>
          <option value="3ro de secundaria">3ro de secundaria</option>
          <option value="4to de secundaria">4to de secundaria</option>
          <option value="5to de secundaria">5to de secundaria</option>
          <option value="6to de secundaria">6to de secundaria</option>
          <option value="Profesor(a)">Profesor(a)</option>
        </optgroup>
      </select>
    </div>
    
    <div class="curso-column">
      <label for="cursoIngles">Curso (Ingl√©s):</label>
      <select id="cursoIngles" aria-label="Curso en ingl√©s">
        <option value="">Select</option>
        <optgroup label="Initial Level">
          <option value="K-4">K-4</option>
          <option value="K-5">K-5</option>
          <option value="Kindergarten">Kindergarten</option>
        </optgroup>
        <optgroup label="Elementary">
          <option value="1st grade">1st grade</option>
          <option value="2nd grade">2nd grade</option>
          <option value="3rd grade">3rd grade</option>
          <option value="4th grade">4th grade</option>
          <option value="5th grade">5th grade</option>
          <option value="6th grade">6th grade</option>
        </optgroup>
        <optgroup label="Middle School">
          <option value="7th grade">7th grade</option>
          <option value="8th grade">8th grade</option>
          <option value="9th grade">9th grade</option>
          <option value="10th grade">10th grade</option>
          <option value="11th grade">11th grade</option>
          <option value="12th grade">12th grade</option>
          <option value="Teacher">Teacher</option>
        </optgroup>
      </select>
    </div>
  </div>

  <input type="hidden" id="cursoEstudiante" value="" />

  <input type="hidden" id="cajaSelect" value="Caja 3" />

  <div id="productos"></div>

  <div class="total">Total: RD$<span id="total">0</span></div>

  <div class="calculadora-cambio">
    <h3>Calcular Cambio</h3>
    <label for="montoPagado">¬øCu√°nto pag√≥ el ni√±o?</label>
    <input type="number" id="montoPagado" placeholder="Ingresa el monto pagado" min="0" />
    <div class="resultado-cambio">
      <div class="cambio-item">
        <span>A pagar:</span>
        <span class="cambio-valor">RD$<span id="apagarCambio">0</span></span>
      </div>
      <div class="cambio-item">
        <span>Pag√≥:</span>
        <span class="cambio-valor">RD$<span id="pagoCambio">0</span></span>
      </div>
      <div class="cambio-item cambio-total">
        <span>Cambio a devolver:</span>
        <span class="cambio-valor cambio-valor-total">RD$<span id="cambio">0</span></span>
      </div>
    </div>
  </div>

  <button class="confirmar" onclick="guardarCompra()">Confirmar compra</button>

  <div class="resumen">
    <h3>Resumen de la compra</h3>
    <pre id="resumen">A√∫n no se ha realizado ninguna compra.</pre>
  </div>

  <div class="historial">
    <h3>Historial</h3>
    <pre id="historial">No hay registros a√∫n.</pre>
  </div>

  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

  <script>
    const productos = [
      { nombre: "Pizza", precio: 85, tipo: "comida" },
      { nombre: "Hot Dog", precio: 110, tipo: "comida" },
      { nombre: "Pastelitos", precio: 50, tipo: "comida" },
      { nombre: "Croquetas", precio: 50, tipo: "comida" },
      { nombre: "Taqueritos", precio: 40, tipo: "comida" },
      { nombre: "Palomitas", precio: 45, tipo: "comida" },
      { nombre: "Refresco", precio: 60, tipo: "comida" },
      { nombre: "Jugo", precio: 45, tipo: "comida" },
      { nombre: "Algod√≥n", precio: 45, tipo: "comida" },
      { nombre: "Donas", precio: 60, tipo: "comida" },
      { nombre: "Galleta glaseada", precio: 110, tipo: "comida" },
      { nombre: "Alfajor", precio: 60, tipo: "comida" },
      { nombre: "Cake Pop", precio: 70, tipo: "comida" },
      { nombre: "Leng√ºita", precio: 35, tipo: "comida" },
      { nombre: "Chocolate", precio: 30, tipo: "comida" },
      { nombre: "Candy Bar peque√±o", precio: 85, tipo: "comida" },
      { nombre: "Candy Bar Mediano", precio: 110, tipo: "comida" },
      { nombre: "Candy Bar Grande", precio: 135, tipo: "comida" },
      { nombre: "Fr√≠o Fr√≠o", precio: 90, tipo: "comida" },
      { nombre: "Penalties", precio: 35, tipo: "actividad" },
      { nombre: "Make your Bracelet", precio: 50, tipo: "actividad" },
      { nombre: "Ring Toss", precio: 25, tipo: "actividad" },
      { nombre: "Just dance", precio: 30, tipo: "actividad" },
      { nombre: "Shake your Body", precio: 10, tipo: "actividad" },
      { nombre: "Decora tu slime", precio: 125, tipo: "actividad" },
      { nombre: "Ponle el beso al Sapo", precio: 25, tipo: "actividad" },
      { nombre: "Pinta carita", precio: 30, tipo: "actividad" },
      { nombre: "Inflables", precio: 50, tipo: "actividad" },
      { nombre: "Videojuegos", precio: 35, tipo: "actividad" },
      { nombre: "Simulador", precio: 60, tipo: "actividad" },
      { nombre: "Realidad virtual", precio: 100, tipo: "actividad" },
      { nombre: "Photobooth", precio: 100, tipo: "actividad" },
      { nombre: "Foto digital", precio: 60, tipo: "actividad" },
      { nombre: "Serenata", precio: 40, tipo: "actividad" },
      { nombre: "Rosa", precio: 80, tipo: "actividad" },
      { nombre: "Carta", precio: 50, tipo: "actividad" },
      { nombre: "VIP", precio: 100, tipo: "actividad" },
      { nombre: "Entrada", precio: 25, tipo: "actividad" }
    ];

    let compra = [];
    let historial = [];

    const productosDiv = document.getElementById('productos');
    const totalSpan = document.getElementById('total');
    const resumenPre = document.getElementById('resumen');
    const historialPre = document.getElementById('historial');
    const montoPagadoInput = document.getElementById('montoPagado');
    const cambioSpan = document.getElementById('cambio');
    const apagarCambioSpan = document.getElementById('apagarCambio');
    const pagoCambioSpan = document.getElementById('pagoCambio');

    // Event listener para calcular cambio
    montoPagadoInput.addEventListener('input', () => {
      actualizarCambio();
    });

    function actualizarCambio() {
      const totalPagar = parseFloat(totalSpan.textContent) || 0;
      const montoPagado = parseFloat(montoPagadoInput.value) || 0;
      const cambio = montoPagado - totalPagar;

      apagarCambioSpan.textContent = totalPagar;
      pagoCambioSpan.textContent = montoPagado;
      cambioSpan.textContent = cambio >= 0 ? cambio : 0;

      // Cambiar color si el cambio es negativo
      if (cambio < 0) {
        cambioSpan.parentElement.style.color = '#e74c3c';
      } else {
        cambioSpan.parentElement.style.color = '#27ae60';
      }
    }

    function crearProductoHTML(producto, index) {
      const div = document.createElement('div');
      div.className = 'producto';

      const label = document.createElement('label');
      label.htmlFor = `producto-${index}`;

      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.id = `producto-${index}`;
      checkbox.addEventListener('change', (e) => {
        if (e.target.checked) {
          agregarProducto(index);
        } else {
          eliminarProducto(index);
        }
      });

      label.appendChild(checkbox);
      label.appendChild(document.createTextNode(producto.nombre + ` (RD$${producto.precio})`));
      div.appendChild(label);

      const controls = document.createElement('div');
      controls.className = 'cantidad-controls';

      const btnMenos = document.createElement('button');
      btnMenos.type = 'button';
      btnMenos.textContent = '-';
      btnMenos.addEventListener('click', () => {
        disminuirCantidad(index);
      });

      const cantidadSpan = document.createElement('span');
      cantidadSpan.id = `cantidad-${index}`;
      cantidadSpan.textContent = '0';

      const btnMas = document.createElement('button');
      btnMas.type = 'button';
      btnMas.textContent = '+';
      btnMas.addEventListener('click', () => {
        aumentarCantidad(index);
      });

      controls.appendChild(btnMenos);
      controls.appendChild(cantidadSpan);
      controls.appendChild(btnMas);

      div.appendChild(controls);

      return div;
    }

    function renderProductos() {
      productosDiv.innerHTML = '';
      let ultimoTipo = null;

      productos.forEach((prod, idx) => {
        // Si cambia el tipo, agregar separador
        if (prod.tipo !== ultimoTipo) {
          ultimoTipo = prod.tipo;
          const titulo = prod.tipo === 'comida' ? 'Comidas' : 'Actividades';
          productosDiv.appendChild(crearSeparador(titulo));
        }

        const prodHTML = crearProductoHTML(prod, idx);
        productosDiv.appendChild(prodHTML);
      });
    }

    function crearSeparador(titulo) {
      const div = document.createElement('div');
      div.className = 'separador';
      div.textContent = titulo;
      return div;
    }

    function agregarProducto(index) {
      if (!compra[index]) {
        compra[index] = 1;
      }
      actualizarCantidadHTML(index);
      actualizarTotal();
    }

    function eliminarProducto(index) {
      compra[index] = 0;
      actualizarCantidadHTML(index);
      actualizarTotal();
      const checkbox = document.getElementById(`producto-${index}`);
      if (checkbox) checkbox.checked = false;
    }

    function aumentarCantidad(index) {
      if (!compra[index]) {
        compra[index] = 1;
        const checkbox = document.getElementById(`producto-${index}`);
        if (checkbox) checkbox.checked = true;
      } else {
        compra[index]++;
      }
      actualizarCantidadHTML(index);
      actualizarTotal();
    }

    function disminuirCantidad(index) {
      if (compra[index] && compra[index] > 1) {
        compra[index]--;
      } else {
        compra[index] = 0;
        const checkbox = document.getElementById(`producto-${index}`);
        if (checkbox) checkbox.checked = false;
      }
      actualizarCantidadHTML(index);
      actualizarTotal();
    }

    function actualizarCantidadHTML(index) {
      const cantidadSpan = document.getElementById(`cantidad-${index}`);
      if (cantidadSpan) {
        cantidadSpan.textContent = compra[index] || 0;
      }
    }

    function actualizarTotal() {
      let total = 0;
      compra.forEach((cant, i) => {
        if (cant) total += cant * productos[i].precio;
      });
      totalSpan.textContent = total;
      actualizarCambio();
    }

    function guardarCompra() {
      const nombre = document.getElementById('nombreEstudiante').value.trim();
      const cursoEspanol = document.getElementById('cursoEspanol').value.trim();
      const cursoIngles = document.getElementById('cursoIngles').value.trim();
      const caja = document.getElementById('cajaSelect').value;

      if (!nombre || (!cursoEspanol && !cursoIngles)) {
        alert('Por favor, ingresa el nombre del estudiante y selecciona al menos un curso.');
        return;
      }

      // Combinar los cursos seleccionados
      let cursoFinal = '';
      if (cursoEspanol && cursoIngles) {
        cursoFinal = `${cursoEspanol} / ${cursoIngles}`;
      } else if (cursoEspanol) {
        cursoFinal = cursoEspanol;
      } else {
        cursoFinal = cursoIngles;
      }

      const ahora = new Date();
      const fechaHora = ahora.toLocaleString('es-DO', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: true
      });

      const firstActivityIndex = productos.findIndex(p => p.nombre === 'H√∫ndelo en el mar');
      const actividadStart = firstActivityIndex >= 0 ? firstActivityIndex : productos.length;

      const itemsComprados = compra
        .map((cantidad, i) => {
          return {
            cantidad,
            producto: productos[i],
            index: i,
            isActividad: i >= actividadStart
          };
        })
        .filter(item => item.cantidad > 0);

      if (itemsComprados.length === 0) {
        alert('Por favor, selecciona al menos un producto con cantidad mayor que 0.');
        return;
      }

      let resumenTexto = `üìÖ Fecha y hora: ${fechaHora}\nüë§ Estudiante: ${nombre}\nüìö Curso: ${cursoFinal}\nüí∞ Caja: ${caja}\n\nüõí Productos:\n`;
      let total = 0;
      itemsComprados.forEach(({ cantidad, producto }) => {
        resumenTexto += `- ${producto.nombre} x ${cantidad} = RD$${cantidad * producto.precio}\n`;
        total += cantidad * producto.precio;
      });
      resumenTexto += `\nüí≥ Total a pagar: RD$${total}`;

      resumenPre.textContent = resumenTexto;

      const registro = {
        nombre,
        curso: cursoFinal,
        items: itemsComprados,
        total,
        caja,
        fechaHora,
        timestamp: ahora.toISOString(),
        txId: `${Date.now()}-${Math.random().toString(36).slice(2,9)}`
      };

      historial.push(registro);
      actualizarHistorial();
      enviarRegistroAGoogleSheet(registro);

      compra = [];
      renderProductos();
      actualizarTotal();
      document.getElementById('nombreEstudiante').value = '';
      document.getElementById('cursoEspanol').value = '';
      document.getElementById('cursoIngles').value = '';
      document.getElementById('montoPagado').value = '';
    }

    function actualizarHistorial() {
      if (historial.length === 0) {
        historialPre.textContent = 'No hay registros a√∫n.';
        return;
      }
      let texto = '';
      historial.forEach((registro, i) => {
        texto += `Compra #${i + 1}\nProductos:\n`;
        registro.items.forEach(({ cantidad, producto }) => {
          texto += `- ${producto.nombre} x ${cantidad} = RD$${cantidad * producto.precio}\n`;
        });
        texto += `Total a pagar: RD$${registro.total}\n\n-----------------------\n\n`;
      });
      historialPre.textContent = texto;
    }

    function enviarRegistroAGoogleSheet(registro) {
      const url = 'https://script.google.com/macros/s/AKfycbwsa1qR4mKAFaF1ruFKCoI7SELFoDiyXgbbyt0jXnRWKDAAoLkk8ZcsubqsRtLMsVgG/exec';
      
      const confirmarBtn = document.querySelector('.confirmar');
      const originalText = confirmarBtn.textContent;
      confirmarBtn.textContent = '‚ö° Guardando...';
      confirmarBtn.disabled = true;
      
      setTimeout(() => {
        confirmarBtn.textContent = originalText;
        confirmarBtn.disabled = false;
        alert('‚úÖ Venta enviada correctamente');
      }, 500);
      
      fetch(url, {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ registro }),
        mode: 'no-cors'
      })
      .catch(error => {
        console.error('Error:', error);
      });
    }

    renderProductos();
  </script>
</body>
</html>
